<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ù†ØµØ© Ø¹Ù…Ø§Ø¯ Ø§Ù„Ø³Ø¹Ø¯ÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© | MARC21 & Z39.50 FIX</title>
<script src="https://cdn.sheetjs.com"></script>
<style>
:root{--primary:#0f172a;--secondary:#e11d48;--accent:#f59e0b;--success:#10b981;--light:#f8fafc;}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:#e2e8f0;margin:0;padding:20px;}
.container{max-width:1600px;margin:auto;background:white;padding:30px;border-radius:20px;box-shadow:0 25px 50px rgba(0,0,0,0.1);border-top:12px solid var(--primary);}
header{text-align:center;margin-bottom:25px;}
.loc-link{background:#fffbeb;border:1px solid #f59e0b;padding:12px;border-radius:8px;display:inline-block;text-decoration:none;color:#b45309;font-weight:bold;margin-bottom:20px;}
.search-engine{background:var(--primary);padding:25px;border-radius:15px;display:flex;gap:10px;margin-bottom:25px;align-items:center;}
.search-engine input{flex:1;padding:15px;border-radius:8px;border:none;font-size:1.1em;outline:none;}
.btn-z39{background:var(--accent);color:var(--primary);padding:15px 30px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;}
.toolbar-group{background:var(--light);padding:15px;border-radius:12px;margin-bottom:12px;border:1px solid #cbd5e0;}
.btns-flex{display:flex;gap:6px;flex-wrap:wrap;}
.btn-tag{padding:8px 12px;font-size:0.8em;background:white;border:1px solid #94a3b8;border-radius:5px;cursor:pointer;font-weight:bold;}
.marc-table{width:100%;border-collapse:collapse;}
.marc-table th{background:var(--primary);color:white;padding:15px;text-align:right;}
.marc-table td{border-bottom:1px solid #e2e8f0;padding:12px;}
.tag-input,.data-input,.toolbar-group input{font-size:1.1em !important;}
.tag-input{width:60px;font-weight:bold;text-align:center;border:2px solid #ddd;padding:8px;border-radius:6px;color:var(--secondary);}
.data-input{width:100%;padding:10px;border:1px solid #94a3b8;border-radius:6px;direction:rtl;}
.side-panel{display:flex;flex-direction:column;gap:20px;}
.preview-box{background:#1e293b;color:#38bdf8;padding:20px;border-radius:15px;font-family:monospace;direction:ltr;text-align:left;min-height:300px;border-left:8px solid var(--accent);white-space:pre-wrap;}
footer{text-align:center;margin-top:40px;padding:25px;background:var(--primary);color:white;border-radius:15px;}
#loader{display:none;color:var(--accent);font-weight:bold;margin-bottom:10px;text-align:center;}
.modal{display:none;position:fixed;z-index:1;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.4);}
.modal-content{background-color:#fefefe;margin:15% auto;padding:20px;border:1px solid #888;width:80%;max-width:500px;border-radius:10px;}
.close{color:#aaa;float:right;font-size:28px;font-weight:bold;}
.close:hover,.close:focus{color:black;text-decoration:none;cursor:pointer;}
.record-item{padding:10px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;}
.record-item button{margin-right:10px;}
</style>
</head>
<body>
<div class="container">
<header>
<h1>Ù†Ø¸Ø§Ù… Ø¹Ù…Ø§Ø¯ Ø§Ù„Ø³Ø¹Ø¯ÙŠ Ù„Ù„ÙÙ‡Ø±Ø³Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© (Z39.50 Ø§Ù„Ù…Ø­Ø§ÙƒÙŠ)</h1>
<a href="https://www.loc.gov" target="_blank" class="loc-link">ğŸ”— Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø±Ø³Ù…ÙŠ: Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙƒÙˆÙ†Ø¬Ø±Ø³ (MARC21 Standards)</a>
</header>

<div class="search-engine">
<input type="text" id="queryInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ ISBN...">
<button class="btn-z39" onclick="fetchZ39Data()">ğŸ“¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
</div>
<div id="loader">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¨Ø¨Ù„ÙŠÙˆØºØ±Ø§ÙÙŠ...</div>

<div class="main-layout" style="display:grid; grid-template-columns: 1fr 400px; gap:30px;">
<div class="editor">

<div class="toolbar-group">
<h4>Ø§Ù„Ù…Ø¯Ø§Ø®Ù„ ÙˆØ§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† (1XX - 2XX)</h4>
<div class="btns-flex">
<button class="btn-tag" onclick="addRow('100','1','#','')">100 Ù…Ø¤Ù„Ù</button>
<button class="btn-tag" onclick="addRow('110','2','#','')">110 Ù‡ÙŠØ¦Ø©</button>
<button class="btn-tag" onclick="addRow('111','2','#','')">111 Ù…Ø¤ØªÙ…Ø±</button>
<button class="btn-tag" onclick="addRow('130','0','#','')">130 Ø¹. Ù…ÙˆØ­Ø¯</button>
<button class="btn-tag" onclick="addRow('245','1','0','')">245 Ø¹Ù†ÙˆØ§Ù†</button>
<button class="btn-tag" onclick="addRow('246','3','0','')">246 Ø¹. Ø¨Ø¯ÙŠÙ„</button>
</div>
</div>

<div class="toolbar-group">
<h4>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ§Øª (6XX - 7XX)</h4>
<div class="btns-flex">
<button class="btn-tag" onclick="addRow('600','1','4','')">600 Ø´Ø®Øµ Ù…ÙˆØ¶ÙˆØ¹</button>
<button class="btn-tag" onclick="addRow('610','2','4','')">610 Ù‡ÙŠØ¦Ø© Ù…ÙˆØ¶ÙˆØ¹</button>
<button class="btn-tag" onclick="addRow('611','2','4','')">611 Ù…Ø¤ØªÙ…Ø± Ù…ÙˆØ¶ÙˆØ¹</button>
<button class="btn-tag" onclick="addRow('650','#','4','')">650 Ù…ÙˆØ¶ÙˆØ¹ Ø¹Ø§Ù…</button>
<button class="btn-tag" onclick="addRow('651','#','4','')">651 Ø¬ØºØ±Ø§ÙÙ€ÙŠ</button>
<button class="btn-tag" onclick="addRow('710','2','#','')">710 Ù‡ÙŠØ¦Ø© Ø«.</button>
<button class="btn-tag" onclick="addRow('711','2','#','')">711 Ù…Ø¤ØªÙ…Ø± Ø«.</button>
</div>
</div>

<div class="toolbar-group">
<h4>Ù…Ø³Ø§Ø¹Ø¯ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ© Ø§Ù„Ø³Ø±ÙŠØ¹:</h4>
<select id="fieldSelector" class="data-input" style="width: 80%;" onchange="addSelectedField()">
<option value="">-- Ø§Ø®ØªØ± Ø­Ù‚Ù„ Ù…Ù† Ø¯Ù„ÙŠÙ„ Ù…Ø§Ø±Ùƒ Ø§Ù„Ø¹Ø±Ø¨ÙŠ --</option>
</select>
</div>

<table class="marc-table">
<thead><tr><th>Ø§Ù„ØªØ§Ø¬</th><th>Ù…Ø¤Ø´Ø±Ø§Øª</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</th><th style="width:40px"></th></tr></thead>
<tbody id="marcBody"></tbody>
</table>
</div>

<div class="side-panel">
<div class="preview-box" id="preview"></div>
<button class="btn-tag" style="background:#007bff;color:white;width:100%;padding:15px;" onclick="saveCurrentRecordPrompt()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
<button class="btn-tag" style="background:#5a6268;color:white;width:100%;padding:15px;" onclick="openManageRecordsModal()">ğŸ“‚ Ø¥Ø¯Ø§Ø±Ø©/ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</button>
<button class="btn-tag" style="background:var(--success);color:white;width:100%;padding:15px;" onclick="exportExcel()">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
<button class="btn-tag" style="background:var(--secondary);color:white;width:100%;margin-top:5px;" onclick="resetForm()">ğŸ”„ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
</div>
</div>

<div id="manageRecordsModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeManageRecordsModal()">&times;</span>
<h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h2>
<div id="recordsList"></div>
</div>
</div>

<footer>Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ±: <b>Ø¹Ù…Ø§Ø¯ ÙƒØ§Ø¸Ù… Ø§Ù„Ø³Ø¹Ø¯ÙŠ</b> &copy; 2024</footer>
</div>

<script>
const marcBody = document.getElementById('marcBody');
const preview = document.getElementById('preview');
const loader = document.getElementById('loader');
const manageRecordsModal = document.getElementById('manageRecordsModal');
const recordsListDiv = document.getElementById('recordsList');
const LOCAL_STORAGE_KEY_CURRENT = 'emad_marc_data_current';
const LOCAL_STORAGE_KEY_LIST = 'emad_marc_saved_list';

const MARC_GUIDE = {
"100":"1# - Ù…Ø¯Ø®Ù„ Ø±Ø¦ÙŠØ³ÙŠ: Ø§Ø³Ù… Ø´Ø®Øµ","110":"2# - Ù…Ø¯Ø®Ù„ Ø±Ø¦ÙŠØ³ÙŠ: Ø§Ø³Ù… Ù‡ÙŠØ¦Ø©",
"111":"2# - Ù…Ø¯Ø®Ù„ Ø±Ø¦ÙŠØ³ÙŠ: Ø§Ø³Ù… Ù…Ø¤ØªÙ…Ø±","130":"0# - Ù…Ø¯Ø®Ù„ Ø±Ø¦ÙŠØ³ÙŠ: Ø¹Ù†ÙˆØ§Ù† Ù…ÙˆØ­Ø¯",
"245":"10 - Ø¨ÙŠØ§Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†","246":"30 - Ø¹Ù†ÙˆØ§Ù† Ø¨Ø¯ÙŠÙ„","250":"## - Ø¨ÙŠØ§Ù† Ø§Ù„Ø·Ø¨Ø¹Ø©",
"264":"#1 - Ø¨ÙŠØ§Ù† Ø§Ù„Ù†Ø´Ø±","300":"## - Ø§Ù„ÙˆØµÙ Ø§Ù„Ù…Ø§Ø¯ÙŠ","490":"0# - Ø¨ÙŠØ§Ù† Ø§Ù„Ø³Ù„Ø³Ù„Ø©",
"500":"## - ØªØ¨ØµØ±Ø© Ø¹Ø§Ù…Ø©","504":"## - ØªØ¨ØµØ±Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹","505":"0# - ØªØ¨ØµØ±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª",
"600":"14 - Ù…ÙˆØ¶ÙˆØ¹: Ø§Ø³Ù… Ø´Ø®Øµ","610":"24 - Ù…ÙˆØ¶ÙˆØ¹: Ø§Ø³Ù… Ù‡ÙŠØ¦Ø©","611":"24 - Ù…ÙˆØ¶ÙˆØ¹: Ù…Ø¤ØªÙ…Ø±",
"650":"#4 - Ù…ÙˆØ¶ÙˆØ¹ Ø¹Ø§Ù…","651":"#4 - Ø§Ø³Ù… Ø¬ØºØ±Ø§ÙÙŠ","700":"1# - Ù…Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ Ø´Ø®Øµ",
"710":"2# - Ù…Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ Ù‡ÙŠØ¦Ø©","711":"2# - Ù…Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ Ù…Ø¤ØªÙ…Ø±"
};

function addRow(tag,i1,i2,data){
const tr=document.createElement('tr');
tr.innerHTML=`
<td><input type="text" class="tag-input" value="${tag}" oninput="updatePreview()"></td>
<td><input type="text" style="width:20px;text-align:center;" value="${i1}"> <input type="text" style="width:20px;text-align:center;" value="${i2}"></td>
<td><input type="text" class="data-input" value="${data}" oninput="updatePreview()"></td>
<td><button onclick="this.parentElement.parentElement.remove();updatePreview()" style="color:red;border:none;background:none;cursor:pointer;">âœ–</button></td>
`;
marcBody.appendChild(tr);
updatePreview();
}

function addSelectedField(){
const tag=document.getElementById('fieldSelector').value;
if(!tag) return;
const description=MARC_GUIDE[tag];
const indicatorsMatch=description.match(/(\w#|\w\d|\d#|\d\d)\s-/);
let i1='#',i2='#';
if(indicatorsMatch){i1=indicatorsMatch[0].charAt(0);i2=indicatorsMatch[0].charAt(1);}
addRow(tag,i1,i2,'');
document.getElementById('fieldSelector').value="";
}

function updatePreview(){
const rows=document.querySelectorAll('#marcBody tr');
let previewText="LDR 00000nam a2200000 u 4500\n";
rows.forEach(row=>{
const tag=row.querySelector('.tag-input').value;
const indicators=Array.from(row.querySelectorAll('input[style*="width:20px"]')).map(i=>i.value||'#').join('');
const data=row.querySelector('.data-input').value;
previewText+=`${tag} ${indicators} ${data}\n`;
});
preview.textContent=previewText;
saveCurrentSession();
}

function getCurrentTableData(){
const rows=document.querySelectorAll('#marcBody tr');
const dataToSave=[];
rows.forEach(row=>{
const tag=row.querySelector('.tag-input').value;
const inds=row.querySelectorAll('input[style*="width:20px"]');
const i1=inds[0].value||'#';
const i2=inds[1].value||'#';
const val=row.querySelector('.data-input').value;
dataToSave.push({tag,i1,i2,val});
});
return dataToSave;
}

function saveCurrentSession(){localStorage.setItem(LOCAL_STORAGE_KEY_CURRENT,JSON.stringify(getCurrentTableData()));}
function loadCurrentSession(){const savedData=localStorage.getItem(LOCAL_STORAGE_KEY_CURRENT);if(savedData){const data=JSON.parse(savedData);data.forEach(item=>addRow(item.tag,item.i1,item.i2,item.val));}}

function saveCurrentRecordPrompt(){
const recordName=prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ø§Ù‹ Ù„Ù„Ø³Ø¬Ù„:");
if(recordName && recordName.trim()!==""){
const data=getCurrentTableData();
localStorage.setItem(`emad_marc_${recordName.trim()}`,JSON.stringify(data));
let savedList=JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_LIST))||[];
if(!savedList.includes(recordName.trim())){savedList.push(recordName.trim());localStorage.setItem(LOCAL_STORAGE_KEY_LIST,JSON.stringify(savedList));}
alert(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ø³Ù…: ${recordName}`);
}else{alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸. Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨.");}
}

function openManageRecordsModal(){
recordsListDiv.innerHTML='';
const savedList=JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_LIST))||[];
if(savedList.length===0){recordsListDiv.innerHTML='<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';}
else{
savedList.forEach(name=>{
const itemDiv=document.createElement('div');itemDiv.classList.add('record-item');
itemDiv.innerHTML=`<span>${name}</span><div><button onclick="loadSpecificRecord('${name}')">ØªØ­Ù…ÙŠÙ„</button><button onclick="deleteRecord('${name}')" style="color:red;">Ø­Ø°Ù</button></div>`;
recordsListDiv.appendChild(itemDiv);
});
}
manageRecordsModal.style.display="block";
}

function closeManageRecordsModal(){manageRecordsModal.style.display="none";}
function loadSpecificRecord(name){
const savedData=localStorage.getItem(`emad_marc_${name}`);
if(savedData){if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ "${name}"ØŸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ.`)){marcBody.innerHTML="";const data=JSON.parse(savedData);data.forEach(item=>addRow(item.tag,item.i1,item.i2,item.val));updatePreview();closeManageRecordsModal();alert(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„: ${name}`);}}
}

function deleteRecord(name){
if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ "${name}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`)){
localStorage.removeItem(`emad_marc_${name}`);
let savedList=JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY_LIST))||[];
savedList=savedList.filter(item=>item!==name);
localStorage.setItem(LOCAL_STORAGE_KEY_LIST,JSON.stringify(savedList));
openManageRecordsModal();
alert(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„: ${name}`);
}
}

function resetForm(){
if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØŸ")){
marcBody.innerHTML="";
localStorage.removeItem(LOCAL_STORAGE_KEY_CURRENT);
updatePreview();
}
}

function exportExcel(){
const wb=XLSX.utils.book_new();
const data=[["Tag","I1","I2","Data"]];
document.querySelectorAll('#marcBody tr').forEach(row=>{
const tag=row.querySelector('.tag-input').value;
const inds=row.querySelectorAll('input[style*="width:20px"]');
const i1=inds[0].value||'#';
const i2=inds[1].value||'#';
const val=row.querySelector('.data-input').value;
data.push([tag,i1,i2,val]);
});
const ws=XLSX.utils.aoa_to_sheet(data);
XLSX.utils.book_append_sheet(wb,ws,"MARC_Record");
XLSX.writeFile(wb,"MARC_Export_Emad.xlsx");
}

function populateSelector(){
const selector=document.getElementById('fieldSelector');
for(let tag in MARC_GUIDE){
let opt=document.createElement('option');
opt.value=tag;
opt.innerHTML=MARC_GUIDE[tag];
selector.appendChild(opt);
}
}

window.onload=()=>{
populateSelector();
loadCurrentSession();
};
</script>
</body>
</html>
